<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Desenho com Cotas e Snap</title>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      overflow: hidden;
    }
    canvas {
      border: 1px solid #ccc;
      display: block;
    }
  </style>
</head>
<body>
  <canvas id="canvas"></canvas>

  <script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    let lines = [];
    let currentLine = null;

    function getMousePos(e) {
      const rect = canvas.getBoundingClientRect();
      return {
        x: e.clientX - rect.left,
        y: e.clientY - rect.top
      };
    }

    function drawSnapBox(x, y) {
      const size = 8;
      ctx.fillStyle = 'rgba(0, 0, 255, 0.4)';
      ctx.fillRect(x - size / 2, y - size / 2, size, size);
    }

    function getSnappedPoint(x, y) {
      const snapDistance = 10;

      for (let line of lines) {
        for (let point of line.points) {
          const dx = x - point.x;
          const dy = y - point.y;
          const dist = Math.sqrt(dx * dx + dy * dy);
          if (dist < snapDistance) {
            return { x: point.x, y: point.y, snapped: true };
          }
        }
      }

      return { x, y, snapped: false };
    }

    function drawDimensions(points) {
      ctx.font = '14px Arial';
      ctx.fillStyle = 'red';

      for (let i = 0; i < points.length - 1; i++) {
        const p1 = points[i];
        const p2 = points[i + 1];
        const dx = p2.x - p1.x;
        const dy = p2.y - p1.y;
        const distance = Math.sqrt(dx * dx + dy * dy);
        const midX = (p1.x + p2.x) / 2;
        const midY = (p1.y + p2.y) / 2;
        ctx.fillText(`${distance.toFixed(1)} px`, midX + 5, midY - 5);
      }
    }

    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      for (let line of lines) {
        if (line.points.length < 2) continue;

        ctx.beginPath();
        ctx.moveTo(line.points[0].x, line.points[0].y);
        for (let i = 1; i < line.points.length; i++) {
          ctx.lineTo(line.points[i].x, line.points[i].y);
        }

        ctx.strokeStyle = 'black';
        ctx.lineWidth = 2;
        ctx.stroke();

        for (let point of line.points) {
          drawSnapBox(point.x, point.y);
        }

        drawDimensions(line.points);
      }
    }

    canvas.addEventListener('mousedown', (e) => {
      const { x, y } = getMousePos(e);
      const snapped = getSnappedPoint(x, y);

      if (!currentLine) {
        currentLine = { points: [snapped], visible: true };
        lines.push(currentLine);
      } else {
        currentLine.points.push(snapped);
      }

      draw();
    });

    canvas.addEventListener('mousemove', (e) => {
      const { x, y } = getMousePos(e);
      const snapped = getSnappedPoint(x, y);

      canvas.style.cursor = snapped.snapped ? 'pointer' : 'crosshair';

      if (currentLine && currentLine.points.length > 0) {
        draw();
        const last = currentLine.points[currentLine.points.length - 1];
        ctx.beginPath();
        ctx.setLineDash([5, 5]);
        ctx.moveTo(last.x, last.y);
        ctx.lineTo(snapped.x, snapped.y);
        ctx.strokeStyle = 'gray';
        ctx.stroke();
        ctx.setLineDash([]);
      }
    });
  </script>
</body>
</html>
