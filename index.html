<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>UrbanMap Pro v14 - CAD Urbanístico</title>
    <title>UrbanMap Pro v15 - NBR Edition</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link rel="stylesheet" href="style.css" />
</head>
<body>
    <div id="loadingScreen" class="loading-screen" role="status" aria-live="polite">
        <div class="loading-spinner" aria-hidden="true"></div>
        <h2>UrbanMap <span class="logo-light">Pro</span></h2>
        <p>Carregando módulos...</p>
        <h2>UrbanMap <span style="font-weight:300">Pro</span></h2>
        <p id="loadingText">Carregando módulos...</p>
    </div>

    <div class="app-container">
        <div class="canvas-layer" id="canvasContainer">
            <canvas id="drawingCanvas"></canvas>
        </div>

        <div class="ui-layer">
            <header class="top-bar floating-panel" role="banner">
                <div class="brand">
                    <i class="fas fa-city logo-icon" aria-hidden="true"></i>
                    <div class="brand-text">
                        <h1>UrbanMap</h1>
                        <span class="project-name">Residencial Modelo</span>
                    </div>
                </div>

                <div class="top-stats" role="status" aria-live="polite">
                    <span class="stat-tag"><i class="fas fa-layer-group" aria-hidden="true"></i> <strong id="headerFloorName">Térreo</strong></span>
                    <span class="stat-tag"><i class="fas fa-search" aria-hidden="true"></i> <strong id="headerZoom">100%</strong></span>
                    <span class="stat-tag helper-tag" id="snapStatus"><i class="fas fa-magnet" aria-hidden="true"></i> Snap: ON</span>
                    <span class="stat-tag helper-tag" id="orthoStatus"><i class="fas fa-ruler-combined" aria-hidden="true"></i> Orto (Shift): OFF</span>
                </div>

                <div class="user-actions">
                    <button class="btn-icon mobile-only" id="btnToggleNav" type="button" title="Alternar painel"><i class="fas fa-bars" aria-hidden="true"></i></button>
                    <button class="btn-primary" id="btnExportJSON" type="button" title="Salvar projeto"><i class="fas fa-save" aria-hidden="true"></i> Salvar</button>
                </div>
            </header>

            <aside class="panel-left floating-panel" id="leftPanel" role="complementary" aria-label="Ferramentas e pavimentos">
                <div class="panel-section highlight-section">
                    <h4><i class="fas fa-map-marker-alt" aria-hidden="true"></i> Definição do Lote</h4>
                    <p class="hint-text">Use "Editar" para mover e inserir novos vértices no lote.</p>
                    <div class="grid-2">
                        <button class="btn-secondary" id="btnDrawLote" type="button"><i class="fas fa-draw-polygon" aria-hidden="true"></i> Desenhar</button>
                        <button class="btn-secondary" id="btnEditLote" type="button"><i class="fas fa-pen-ruler" aria-hidden="true"></i> Editar</button>
                    </div>
                    <div id="loteInfoBox" class="info-box" style="display:none;">
                        <div class="info-row">
                            <span>Área Total:</span>
                            <strong id="loteAreaDisplay">0 m²</strong>
                        </div>
                        <div class="info-row">
                            <span>Zoneamento:</span>
                            <select id="loteZoning" class="mini-select" aria-label="Zoneamento do lote">
                    <button class="btn-icon mobile-only" id="btnToggleNav" type="button" aria-label="Alternar painel móvel"><i class="fas fa-bars"></i></button>
                    <button class="btn-primary" id="btnExportJSON" type="button"><i class="fas fa-save"></i> Salvar</button>
                    <button class="btn-icon" id="btnHelp" type="button" title="Ajuda"><i class="fas fa-question"></i></button>
                </div>
            </header>

            <aside class="panel-left floating-panel" id="leftPanel">
                <div class="panel-section highlight-section">
                    <div class="header-split">
                        <h4><i class="fas fa-map-marker-alt"></i> Definição do Lote</h4>
                    </div>
                    <div class="lote-control">
                        <button class="btn-secondary full-width" id="btnDrawLote" type="button">
                            <i class="fas fa-draw-polygon"></i> Desenhar Perímetro
                        </button>
                    </div>
                    <div id="loteInfoBox" class="info-box" style="display:none;">
                        <div class="info-row">
                            <span>Área Total:</span> <strong id="loteAreaDisplay">0 m²</strong>
                        </div>
                        <div class="info-row">
                            <span>Zon:</span>
                            <select id="loteZoning" class="mini-select">
                                <option value="ZR-3">ZR-3</option>
                                <option value="ZR-4">ZR-4</option>
                                <option value="ECO-1">Estrutural</option>
                            </select>
                            <button class="btn-icon" id="btnEditLote" title="Editar Vértices"><i class="fas fa-edit"></i></button>
                        </div>
                        <div id="vertexZControl" class="info-row" style="display:none; border-top:1px solid rgba(255,255,255,0.1); padding-top:6px; margin-top:6px;">
                            <span>Cota (Z) Vértice:</span>
                            <input type="number" id="inputVertexZ" class="mini-input" step="0.1" value="0.0">
                        </div>
                    </div>
                </div>

                <div class="divider"></div>

                <div class="panel-section">
                    <h4><i class="fas fa-pen-fancy" aria-hidden="true"></i> Projetar Edificação</h4>
                    <div class="toolbar-grid">
                        <button class="tool-btn active" data-tool="select" type="button" title="Selecionar (V)"><i class="fas fa-mouse-pointer" aria-hidden="true"></i> <span>Select</span></button>
                        <button class="tool-btn" data-tool="pan" type="button" title="Pan (Space)"><i class="fas fa-hand-paper" aria-hidden="true"></i> <span>Pan</span></button>
                        <button class="tool-btn" data-tool="rectangle" type="button" title="Retângulo (R)"><i class="fas fa-vector-square" aria-hidden="true"></i> <span>Ret.</span></button>
                        <button class="tool-btn" data-tool="polygon" type="button" title="Polígono (P)"><i class="fas fa-draw-polygon" aria-hidden="true"></i> <span>Polig.</span></button>
                        <button class="tool-btn" data-tool="edit-building" type="button" title="Editar polígono"><i class="fas fa-bezier-curve" aria-hidden="true"></i> <span>Editar</span></button>
                        <button class="tool-btn" data-tool="cut" type="button" title="Corte esquemático"><i class="fas fa-cut" aria-hidden="true"></i> <span>Corte</span></button>
                    <h4><i class="fas fa-pen-fancy"></i> Projetar</h4>
                    <div class="toolbar-grid">
                        <button class="tool-btn active" data-tool="select" title="Selecionar (V)"><i class="fas fa-mouse-pointer"></i><span>Select</span></button>
                        <button class="tool-btn" data-tool="pan" title="Mover (Espaço ou Scroll)"><i class="fas fa-hand-paper"></i><span>Pan</span></button>
                        <button class="tool-btn" data-tool="rectangle" title="Retângulo (R)"><i class="fas fa-vector-square"></i><span>Ret.</span></button>
                        <button class="tool-btn" data-tool="polygon" title="Polígono (P)"><i class="fas fa-draw-polygon"></i><span>Polig.</span></button>
                        <button class="tool-btn" data-tool="edit-building" title="Editar Vértices"><i class="fas fa-bezier-curve"></i><span>Editar</span></button>
                        <button class="tool-btn" data-tool="cut-line" title="Traçar Linha de Corte"><i class="fas fa-cut"></i><span>Corte</span></button>
                    </div>
                </div>

                <div class="divider"></div>

                <div class="panel-section">
                    <div class="header-split floor-header">
                        <h4><i class="fas fa-layer-group" aria-hidden="true"></i> Pavimentos</h4>
                        <div class="inline-actions">
                            <button class="btn-icon" id="btnAddFloor" type="button" title="Adicionar"><i class="fas fa-plus" aria-hidden="true"></i></button>
                            <button class="btn-icon" id="btnRenameFloor" type="button" title="Renomear"><i class="fas fa-i-cursor" aria-hidden="true"></i></button>
                            <button class="btn-icon" id="btnRemoveFloor" type="button" title="Remover"><i class="fas fa-trash" aria-hidden="true"></i></button>
                        </div>
                    </div>
                    <div id="floorsList" class="list-container" aria-live="polite"></div>
                </div>
            </aside>

            <aside class="panel-right floating-panel" id="rightPanel" role="region" aria-label="Índices Urbanísticos">
                <div class="panel-header-simple">
                    <h3><i class="fas fa-chart-pie" aria-hidden="true"></i> Índices Urbanísticos</h3>
                </div>

                <div class="scrollable-content">
                    <div class="metric-card">
                        <div class="metric-header">
                            <span>Taxa de Ocupação (TO)</span>
                            <span class="badge-limit">Max: <span id="limitTO">50</span>%</span>
                        </div>
                        <div class="metric-main">
                            <span class="big-number" id="valCurrentTO">0%</span>
                            <small class="sub-value" id="areaOcupadaDisplay">0 m² ocupados</small>
                        </div>
                        <div class="progress-bar"><div class="progress-fill" id="barTO" style="width: 0%"></div></div>
                        <div class="status-text" id="statusTO">Dentro do limite</div>
                    </div>

                    <div class="metric-card">
                        <div class="metric-header">
                            <span>Coef. Aproveitamento (CA)</span>
                            <span class="badge-limit">Max: <span id="limitCA">1.0</span></span>
                        </div>
                        <div class="metric-main">
                            <span class="big-number" id="valCurrentCA">0.00</span>
                            <small class="sub-value" id="areaTotalConstruidaDisplay">0 m² constr.</small>
                        </div>
                        <div class="progress-bar"><div class="progress-fill" id="barCA" style="width: 0%"></div></div>
                        <div class="status-text" id="statusCA">Dentro do limite</div>
                    </div>

                    <div class="divider"></div>

                    <h4 class="section-title">Edificações (Pav. Atual)</h4>
                    <div id="buildingsList" class="list-container buildings-list-scroll" aria-live="polite">
                        <div class="empty-state">Nenhuma edificação neste nível.</div>
                    </div>
                </div>
            </aside>

            <footer class="bottom-bar floating-panel" role="contentinfo">
                <div class="coords" id="mouseCoords">X: 0.00 m, Y: 0.00 m</div>
                <div class="status-info"><span id="toolHint">Selecione uma ferramenta</span></div>
            </footer>

            <nav class="mobile-panel-nav floating-panel" aria-label="Navegação rápida">
                <button type="button" class="mobile-nav-btn active" data-panel-target="left">Ferramentas</button>
                <button type="button" class="mobile-nav-btn" data-panel-target="right">Índices</button>
            </nav>
                        <h4><i class="fas fa-layer-group"></i> Pavimentos</h4>
                        <div class="inline-actions">
                            <button class="btn-icon" id="btnRemoveFloor" title="Remover"><i class="fas fa-trash"></i></button>
                            <button class="btn-icon" id="btnAddFloor" title="Adicionar"><i class="fas fa-plus"></i></button>
                        </div>
                    </div>
                    <div id="floorsList" class="list-container"></div>
                </div>
            </aside>

            <aside class="panel-right floating-panel" id="rightPanel">
                <div class="panel-header-simple"><h3><i class="fas fa-chart-pie"></i> Índices Urbanísticos</h3></div>
                <div class="scrollable-content">
                    <div class="metric-card">
                        <div class="metric-header"><span>TO (Ocupação)</span> <span class="badge-limit">Max: <span id="limitTO">50</span>%</span></div>
                        <div class="metric-main"><span class="big-number" id="valCurrentTO">0%</span></div>
                        <div class="progress-bar"><div class="progress-fill" id="barTO" style="width: 0%"></div></div>
                        <div class="status-text" id="statusTO">Dentro do limite</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-header"><span>CA (Aproveitamento)</span> <span class="badge-limit">Max: <span id="limitCA">1.0</span></span></div>
                        <div class="metric-main"><span class="big-number" id="valCurrentCA">0.00</span></div>
                        <div class="progress-bar"><div class="progress-fill" id="barCA" style="width: 0%"></div></div>
                        <div class="status-text" id="statusCA">Dentro do limite</div>
                    </div>
                    <div class="divider"></div>
                    <h4 class="section-title">Edificações (Nível Atual)</h4>
                    <div id="buildingsList" class="list-container"></div>
                </div>
            </aside>

            <footer class="bottom-bar floating-panel">
                <div class="coords" id="mouseCoords">X: 0.00 m, Y: 0.00 m</div>
                <div id="toolHint">Selecione uma ferramenta</div>
            </footer>
        </div>
    </div>

    <div id="cutModal" class="cut-modal" aria-hidden="true">
        <div class="cut-panel floating-panel">
            <div class="header-split">
                <h3>Corte Esquemático</h3>
                <button id="btnCloseCut" class="btn-icon" type="button"><i class="fas fa-times" aria-hidden="true"></i></button>
            </div>
            <canvas id="cutCanvas" width="740" height="280"></canvas>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
                <h3>Corte Esquemático (NBR)</h3>
                <button id="btnCloseCut" class="btn-icon" type="button"><i class="fas fa-times" aria-hidden="true"></i></button>
            </div>
            <div class="cut-container">
                <canvas id="cutCanvas" width="800" height="400"></canvas>
            </div>
            <div style="margin-top:10px; font-size:12px; color:#9ca3af;">
                * Perfil do terreno interpolado. Edificações projetadas.
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/fabric@5.3.0/dist/fabric.min.js"></script>
    <script>
        // Verificação de segurança se o Fabric carregou
        window.addEventListener('load', function() {
            if (typeof fabric === 'undefined') {
                document.getElementById('loadingText').innerText = "Erro: Fabric.js não carregou. Verifique sua conexão.";
                document.getElementById('loadingText').style.color = "#ef4444";
            }
        });
    </script>
    <script src="main.js"></script>
</body>
</html>
